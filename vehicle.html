<html>
<script language="javascript" type="text/javascript" src="p5.min.js"></script>
<script language="javascript" type="text/javascript">
var target = {x:250, y:250};
var pos = {x:0, y:0};
var vel = {x:0, y:0};
var veld = {x:0, y:0};
var THETA = 0;
var VEL = 1;
var THETADOT = 2;
var state = [0.,0.,0.];
var deriv = [0.,0.,0.];
var width = 500;
var height = 500;
var behavior = null;
var maxTorque = 40.0;
var maxForce = 1000.0;
var maxSpeed = 300.0;
var arrivalDistance = 100;
function setup() 
{
    width = 500.0;
    height = 500.0;
    createCanvas(width, height);
    console.log("TEST");
    behavior = function() {
        vd = {x: target.x-pos.x, y: target.y-pos.y};
        mag = Math.sqrt(vd.x*vd.x + vd.y*vd.y);
        var speed = maxSpeed;
        if (mag < arrivalDistance) // slowdown
        {
            var a = (mag/arrivalDistance);
            speed = maxSpeed * a * a * a;
        }
        vd.x = vd.x * (speed/mag);
        vd.y = vd.y * (speed/mag);
        return vd;
    }
}

function signedMod(a, n) 
{
   return a - Math.floor(a/n) * n;
}

function draw() 
{
   background(230);

   if (mouseX > 0 && mouseX < width && mouseY > 0 && mouseY < height && mouseIsPressed)
   {
       target.x = mouseX;
       target.y = mouseY;
   }   

   var dt = Number(document.getElementById("dt").value);
   var velKv = Number(document.getElementById("Velkv").value);
   var oriKp = Number(document.getElementById("Orikp").value);
   var oriKv = Number(document.getElementById("Orikv").value);
   var m = Number(document.getElementById("Mass").value);
   var I = Number(document.getElementById("Inertia").value);

   fill(255,0,0);
   noStroke();
   ellipse(target.x, target.y, 15, 15);

   fill(0,0,255);
   ellipse(pos.x, pos.y, 25, 25);
   stroke(0,0,0);
   line(pos.x, pos.y, pos.x+vel.x, pos.y+vel.y);
   stroke(0,255,0);
   line(pos.x, pos.y, pos.x+veld.x, pos.y+veld.y);

   // compute vd
   var vd = behavior();
   var thetad = Math.atan2(vd.y, vd.x);
   var vdspeed = Math.sqrt(vd.x*vd.x + vd.y*vd.y);

   // compute control laws
   // compute smallest angle between thetad and current theta
   var angleDiff = signedMod((thetad - state[THETA] + Math.PI), Math.PI * 2.0) - Math.PI;

   var f = m * velKv * (vdspeed - state[VEL]);
   var t = I * (oriKp * (angleDiff) - oriKv * (state[THETADOT]));

   //f = Math.min(maxForce, Math.max(-maxForce, f));
   t = Math.min(maxTorque, Math.max(-maxTorque, t));

   // compute derivatives and perform Euler step
   deriv[THETA] = state[THETADOT];
   deriv[VEL] = f/m;
   deriv[THETADOT] = t/I;

   for (var i = 0; i < state.length; i++) {
       state[i] += deriv[i] * dt;
   }

   // convert local values to global values
   vel.x = Math.cos(state[THETA]) * state[VEL];
   vel.y = Math.sin(state[THETA]) * state[VEL];

   pos.x = pos.x + vel.x * dt;
   pos.y = pos.y + vel.y * dt;

   veld = vd; 
   //console.log(state);

   stroke(0,255,0);
   line(2, 2, 2, 250);

   stroke(255,0,0);
   line(2, 2, 250, 2);
}

</script>
<body>
Dt:<input id="dt" type="number" step="0.01" value="0.01"><br>
Ori Kv: <input id="Orikv" type="number" step="0.1" value="20"><br>
Ori Kp: <input id="Orikp" type="number" step="0.1" value="100"><br>
Vel Kv: <input id="Velkv" type="number" step="0.1" value="5"><br>
Mass: <input id="Mass" type="number" step="0.1" value="1"><br>
Inertia: <input id="Inertia" type="number" step="0.1" value="1"><br>
</body>
</html>


