<html>
<script language="javascript" type="text/javascript" src="p5.min.js"></script>
<script language="javascript" type="text/javascript">
var target = {x:250, y:250};
var pos = {x:0, y:0};
var vel = {x:0, y:0};
var veld = {x:0, y:0};
var THETA = 0;
var VEL = 1;
var THETADOT = 2;
var state = [0.,0.,0.];
var deriv = [0.,0.,0.];
var width = 1000;
var height = 800;
var behavior = null;
var maxTorque = 40.0;
var maxForce = 1000.0;
var maxSpeed = 300.0;
var arrivalDistance = 100;

var b0 = {x: 86, y: 330};
var b1 = {x: 76, y: 182};
var b2 = {x: 568, y: 82};
var b3 = {x: 954, y: 211};

function drawPath() {
   stroke(200, 50, 50);
   var step = 0.1;
   var lastP = b0;
   for (var t = step; t < 1.0; t += step)
   {
      var b01x = b0.x * (1-t) + b1.x * t;
      var b01y = b0.y * (1-t) + b1.y * t;

      var b11x = b1.x * (1-t) + b2.x * t;
      var b11y = b1.y * (1-t) + b2.y * t;

      var b21x = b2.x * (1-t) + b3.x * t;
      var b21y = b2.y * (1-t) + b3.y * t;

      var b02x = b01x * (1-t) + b11x * t;
      var b02y = b01y * (1-t) + b11y * t;

      var b12x = b11x * (1-t) + b21x * t;
      var b12y = b11y * (1-t) + b21y * t;

      var b03x = b02x * (1-t) + b12x * t;
      var b03y = b02y * (1-t) + b12y * t;

      var p = {x: b03x, y: b03y};
      line(lastP.x, lastP.y, p.x, p.y);
      lastP = p;
   }
}

function followPath() {
    drawPath();
    
    return seek();
}

function flee() {
    vd = {x: -target.x+pos.x, y: -target.y+pos.y};
    mag = Math.sqrt(vd.x*vd.x + vd.y*vd.y);
    var speed = maxSpeed;
    vd.x = vd.x * (speed/mag);
    vd.y = vd.y * (speed/mag);
    return vd;
}

function seek() {
    vd = {x: target.x-pos.x, y: target.y-pos.y};
    mag = Math.sqrt(vd.x*vd.x + vd.y*vd.y);
    var speed = maxSpeed;
    vd.x = vd.x * (speed/mag);
    vd.y = vd.y * (speed/mag);
    return vd;
}

function arrival() {
    vd = {x: target.x-pos.x, y: target.y-pos.y};
    mag = Math.sqrt(vd.x*vd.x + vd.y*vd.y);
    var speed = maxSpeed;
    if (mag < arrivalDistance) // slowdown
    {
        var a = (mag/arrivalDistance);
        speed = maxSpeed * a * a * a;
    }
    vd.x = vd.x * (speed/mag);
    vd.y = vd.y * (speed/mag);
    return vd;
}

function setup() 
{
    width = 1000.0;
    height = 800.0;
    createCanvas(width, height);
    behavior = arrival;
}

function signedMod(a, n) 
{
   return a - Math.floor(a/n) * n;
}

function getBehavior()
{
   var e = document.getElementById("behavior");
   var strUser = e.options[e.selectedIndex].value;
   if (strUser === "seek") return seek;
   if (strUser === "flee") return flee;
   if (strUser === "path") return followPath;
   return arrival;
}

function draw() 
{
   background(230);

   if (mouseX > 0 && mouseX < width && mouseY > 0 && mouseY < height && mouseIsPressed)
   {
       target.x = mouseX;
       target.y = mouseY;
   }   

   var dt = Number(document.getElementById("dt").value);
   var velKv = Number(document.getElementById("Velkv").value);
   var oriKp = Number(document.getElementById("Orikp").value);
   var oriKv = Number(document.getElementById("Orikv").value);
   var m = Number(document.getElementById("Mass").value);
   var I = Number(document.getElementById("Inertia").value);
   var e = document.getElementById("behavior");
   behavior = getBehavior(strUser = e.options[e.selectedIndex].value);

   fill(255,0,0);
   noStroke();
   ellipse(target.x, target.y, 15, 15);

   fill(0,0,255);
   ellipse(pos.x, pos.y, 25, 25);
   stroke(0,0,0);
   line(pos.x, pos.y, pos.x+vel.x, pos.y+vel.y);
   stroke(0,255,0);
   line(pos.x, pos.y, pos.x+veld.x, pos.y+veld.y);

   // compute vd
   var vd = behavior();
   var thetad = Math.atan2(vd.y, vd.x);
   var vdspeed = Math.sqrt(vd.x*vd.x + vd.y*vd.y);

   // compute control laws
   // compute smallest angle between thetad and current theta
   var angleDiff = signedMod((thetad - state[THETA] + Math.PI), Math.PI * 2.0) - Math.PI;

   var f = m * velKv * (vdspeed - state[VEL]);
   var t = I * (oriKp * (angleDiff) - oriKv * (state[THETADOT]));

   //f = Math.min(maxForce, Math.max(-maxForce, f));
   t = Math.min(maxTorque, Math.max(-maxTorque, t));

   // compute derivatives and perform Euler step
   deriv[THETA] = state[THETADOT];
   deriv[VEL] = f/m;
   deriv[THETADOT] = t/I;

   for (var i = 0; i < state.length; i++) {
       state[i] += deriv[i] * dt;
   }

   // convert local values to global values
   vel.x = Math.cos(state[THETA]) * state[VEL];
   vel.y = Math.sin(state[THETA]) * state[VEL];

   pos.x = pos.x + vel.x * dt;
   pos.y = pos.y + vel.y * dt;

   veld = vd; 
   //console.log(state);

   stroke(0,255,0);
   line(2, 2, 2, 250);

   stroke(255,0,0);
   line(2, 2, 250, 2);
}

</script>
<body>
Dt:<input id="dt" type="number" step="0.01" value="0.01"><br>
Ori Kv: <input id="Orikv" type="number" step="0.1" value="20"><br>
Ori Kp: <input id="Orikp" type="number" step="0.1" value="100"><br>
Vel Kv: <input id="Velkv" type="number" step="0.1" value="5"><br>
Mass: <input id="Mass" type="number" step="0.1" value="1"><br>
Inertia: <input id="Inertia" type="number" step="0.1" value="1"><br>
<select id="behavior">
    <option value="arrival">Arrival</option>
    <option value="seek">Seek</option>
    <option value="flee">Flee</option>
    <option value="path">Path</option>
</select>
<br>
</body>
</html>


